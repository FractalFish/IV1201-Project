# ADR-001: Azure Deployment Fixes

**Status:** Implemented
**Date:** 2026-02-14
**Decision Makers:** Development Team

## Context

The IV1201 Recruitment Application was being deployed to Azure App Service using Docker containers with Azure PostgreSQL Flexible Server as the database. The deployment pipeline was successfully building and pushing Docker images, but the application was failing to start in Azure with database migration errors.

## Problem

Two critical issues prevented successful deployment:

1. **PostgreSQL Role Error**: Flyway migration V1__schema.sql failed with:
   ```
   ERROR: role "postgres" does not exist
   Location: db/migration/V1__schema.sql
   Line: 35
   ```

2. **Extension Not Allowed Error**: Flyway migration V2__password_migration.sql failed with:
   ```
   ERROR: extension "pgcrypto" is not allow-listed for users in Azure Database for PostgreSQL
   Location: db/migration/V2__password_migration.sql
   Line: 12
   ```

## Decision

### Fix 1: Remove ALTER TABLE OWNER Statements

**What:** Removed all `ALTER TABLE ... OWNER TO postgres;` statements from V1__schema.sql

**Why:**
- Azure PostgreSQL databases don't have a default "postgres" role
- These statements were auto-generated by pg_dump but are not required for the application to function
- They only set metadata about table ownership, which doesn't affect application functionality

**Implementation:**
```bash
sed -i '/^ALTER TABLE.*OWNER TO postgres;$/d' src/main/resources/db/migration/V1__schema.sql
```

**Files Changed:**
- `src/main/resources/db/migration/V1__schema.sql` - Removed 5 ALTER TABLE OWNER statements

### Fix 2: Enable pgcrypto Extension in Azure

**What:** Enabled the `pgcrypto` extension in Azure PostgreSQL Flexible Server configuration

**Why:**
- V2__password_migration.sql uses pgcrypto for BCrypt password hashing
- Azure PostgreSQL requires extensions to be explicitly allow-listed for security
- pgcrypto is a trusted extension available in Azure's allowed list

**Implementation:**
```bash
az postgres flexible-server parameter set \
  --name azure.extensions \
  --value "PGCRYPTO" \
  --resource-group iv1201-rg \
  --server-name iv1201-postgres
```

**Azure Configuration:**
- Resource: `iv1201-postgres` (PostgreSQL 16 Flexible Server)
- Parameter: `azure.extensions`
- Value: `PGCRYPTO`

## Consequences

### Positive
- Application successfully deploys and starts on Azure
- Database migrations complete successfully
- Application accessible at https://iv1201-recruitment.azurewebsites.net/
- Passwords properly hashed using BCrypt via pgcrypto

### Negative
- Migration files differ slightly from original pg_dump output
- Azure-specific configuration required (extension allow-listing)
- Team must remember to enable pgcrypto when setting up new database instances

### Neutral
- Table ownership defaults to the connection user instead of "postgres" role
- This has no functional impact on the application

## Alternatives Considered

### Alternative 1: Modify Azure PostgreSQL to Support "postgres" Role
- **Rejected**: Azure doesn't allow creating roles with reserved names
- Would require significant infrastructure changes

### Alternative 2: Replace pgcrypto with Java-based BCrypt
- **Rejected**: Would require:
  - Rewriting V2 migration to use Java code
  - More complex migration logic
  - Less database-native solution
- pgcrypto is the standard PostgreSQL approach

### Alternative 3: Use Different Password Hashing Extension
- **Rejected**: pgcrypto is:
  - Industry standard
  - Well-tested and secure
  - Already implemented in the migration scripts

## References

- [Azure PostgreSQL Extensions Documentation](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-extensions)
- GitHub Actions Workflow: `.github/workflows/ci-cd.yml`
- Migration Files:
  - `src/main/resources/db/migration/V1__schema.sql`
  - `src/main/resources/db/migration/V2__password_migration.sql`
- Related ADRs:
  - ADR-002 (Flyway Database Migrations)
  - ADR-003 (CI/CD Pipeline Implementation)

## Verification

Application successfully deployed and verified:
```bash
curl -I https://iv1201-recruitment.azurewebsites.net/
# HTTP/1.1 302 Found
# Location: https://iv1201-recruitment.azurewebsites.net/login

curl -sL https://iv1201-recruitment.azurewebsites.net/login | grep title
# <title>Login</title>
```

All Flyway migrations completed successfully with no errors.

---

## Simplified ADR Entry (Wiki Format)

**Azure PostgreSQL Deployment Compatibility**

Date: 2026-02-14  Status: Implemented

Decision: Remove ALTER TABLE OWNER statements from migration scripts and enable pgcrypto extension in Azure PostgreSQL.

Description: Azure PostgreSQL databases don't have a default "postgres" role, causing Flyway migrations to fail. Removed ownership statements as they're not functionally necessary. Enabled pgcrypto extension for BCrypt password hashing required by migration V2. These changes enable successful deployment to Azure while maintaining full application functionality.
